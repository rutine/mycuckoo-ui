<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>统一用户</title>
  <link type="image/x-icon" href="../../static/images/favicon.ico" rel="shortcut icon" />
  <link type="text/css" href="../../static/layui/2.9.8/css/layui.css" rel="stylesheet" />
  <link type="text/css" href="../../static/dtree/css/dtree.css" rel="stylesheet" />
  <link type="text/css" href="../../static/dtree/css/font/dtreefont.css" rel="stylesheet" />
  <link type="text/css" href="../../static/css/mycuckoo.css" rel="stylesheet" />
</head>
<body>
<div class="mycuckoo-site-nav">
    <span class="layui-breadcrumb">
      <a href="javascript:;">我的桌面</a>
      <a><cite>用户管理</cite></a>
    </span>
  <span class="right">
      <a class="layui-btn layui-btn-sm" href="javascript:location.replace(location.href);" title="刷新">
        <i class="layui-icon layui-icon-refresh"></i>
      </a>
    </span>
</div>

<div class="mycuckoo-main">
  <div class="layui-row">
    <form class="layui-col-md12 layui-form mycuckoo-search">
      <div class="layui-inline">
        <div class="layui-input-inline">
          <input class="layui-input" name="q[code]" placeholder="用户号">
        </div>
        <div class="layui-input-inline">
          <input class="layui-input" name="q[name]" placeholder="用户名">
        </div>
        <div class="layui-input-inline">
          <button class="layui-btn" lay-filter="search" lay-submit>
            <i class="layui-icon">&#xe615;</i>
          </button>
        </div>
      </div>
    </form>
  </div>

  <table id="ID_table" class="layui-hide" lay-filter="table"></table>
</div>
</body>
<script type="text/javascript" src="../../static/layui/2.9.8/layui.js" charset="UTF-8"></script>
<script type="text/javascript" src="../../static/mycuckoo.js" charset="UTF-8"></script>
<script type="text/javascript" src="../../static/mycuckoo.api.js" charset="UTF-8"></script>
<script type="text/html" id="ID_toolbar">
  <div class="layui-btn-group btn-toolbar">
    {{# layui.each(d.operator, function(index, item){ }}
    <button class="layui-btn layui-btn-sm" lay-event="{{ item.code }}">
      <i class="layui-icon layui-icon-{{ item.iconCls }}"></i> {{ item.name }}
    </button>
    {{# }); }}
  </div>
</script>
<script type="text/javascript">
  layui.config({
    base: '../../static/extend/',
    version: '101100'
  });

  layui.use(['jquery', 'form', 'table', 'dtree'], function() {
    var $ = layui.jquery,
      form = layui.form,
      tree = layui.dtree,
      table = layui.table;

    //本地缓存数据
    var queryObj = MyCuckoo.getQueryObject(location.search);
    var operator = MyCuckoo.getOperation(queryObj.id);

    form.on('submit(search)', function(data) {
      //执行重载
      table.reload('table', {
        page: {
          pageNo: 1 //重新从第 1 页开始
        },
        where: data.field
      });

      return false;
    });

    table.render({
      id: 'table',
      elem: '#ID_table',
      url: api.userMgr.url,
      method: 'get',
      cellMinWidth: 100,
      height: MyCuckoo.tableHeight,
      toolbar: '#ID_toolbar',
      operator: operator,
      cols: [[
        {type: 'numbers'},
        {type: 'radio'},
        {field: 'code', title: '编号'},
        {field: 'name', title: '名称'},
        {field: 'gender', title: '性别',
          templet: function(d) {
            if(d.gender == '0') {
              return '男';
            } else if(d.gender == '1') {
              return '女';
            }
          }
        },
        {field: 'position', title: '职位'},
        {field: 'qq', title: 'QQ'},
        {field: 'phone', title: '手机'},
        {field: 'mail', title: '邮件'},
        {field: 'orgName', title: '所属机构'},
        {field: 'roleName', title: '所属角色'},
        {field: 'status', title: '用户状态',
          templet: function(d) {
            if(d.status == 'enable') {
              return '启用';
            } else if(d.status == 'disable') {
              return '停用';
            }
          }
        },
        {field: 'creator', title: '创建人'},
        {field: 'createDate', title: '创建日期', sort: true}
      ]],
      page: true,
      request: {
        pageName: 'pageNo',
        limitName: 'pageSize'
      },
      parseData: function(res) {
        return {
          code: res.code,
          msg: res.message,
          count: res.data.totalElements,
          data: res.data.content
        }
      }
    });

    table.on('toolbar(table)', function (obj) {
      if (obj.event.indexOf('LAYTABLE_') == 0) {
        return;
      }
      if (obj.event == 'add') {
        active[obj.event](obj);
        return;
      }

      var data = table.checkStatus(obj.config.id).data;
      if (data.length != 1) {
        MyCuckoo.alert({title : '提示', msg : '请选择一条记录' });
        return;
      }

      if (!active[obj.event]) {
        MyCuckoo.alert({title : '警示', msg : '此操作无效, 如有疑问, 请联系管理员!' });
        return;
      }

      obj.data = data[0];
      active[obj.event](obj);
    });

    function reload() {
      table.reload('table', { page: { pageNo: 1 } });
    }

    var active = {
      //增加
      add: function(obj) {
        var url = MyCuckoo.resolve('userMgrForm.html?action={_event}&opt={_opt}',
            {'_event': obj.event, '_opt': queryObj.id})
        MyCuckoo.dialog('用户信息', url);
      },
      //修改
      modify: function(obj) {
        var data = obj.data;
        var url = MyCuckoo.resolve('userMgrForm.html?action={_event}&opt={_opt}&id={id}',
            {'_event': obj.event, '_opt': queryObj.id, 'id': data.userId})
        MyCuckoo.dialog('用户信息', url);
      },
      //查看
      view: function(obj) {
        var data = obj.data;
        var url = MyCuckoo.resolve('userMgrForm.html?action={_event}&opt={_opt}&id={id}',
            {'_event': obj.event, '_opt': queryObj.id, 'id': data.userId})
        MyCuckoo.dialog('用户信息', url);
      },
      //删除
      delete: function(obj) {
        var data = obj.data;
        MyCuckoo.confirm({title: '警告提示', msg: '您确认删除此记录吗?',
          okBtn: '是', cancelBtn: '否', ok: function() {
            $.delete(api.userMgr.url + '/' + data.userId, {}).then(json => {
              MyCuckoo.msg({ msg: json.message });

              reload(); // 刷新列表
            });
          }});
      },
      //启用
      enable: function(obj) {
        var data = obj.data;
        if(data.status == 'enable') {
          MyCuckoo.msg({ msg : '此用户已经启用' });
          return;
        }

        $.put(api.userMgr.disEnableUrl, {id: data.userId, disEnableFlag: 'enable'}).then(json => {
          MyCuckoo.msg({ msg: '用户启用成功' });

          reload(); // 刷新列表
        });
      },
      //停用
      disable: function(obj) {
        var data = obj.data;
        if(data.status == 'disable') {
          MyCuckoo.alert({ title : '提示', msg : '此用户已经停用' });
          return;
        }

        MyCuckoo.confirm({msg : '您确认停用此用户?如停用,此用户将归入无角色用户并自动清除所有权限.', ok : function() {
          $.put(api.userMgr.disEnableUrl, {id: data.userId, disEnableFlag: 'disable'}).then(json => {
            MyCuckoo.msg({ msg: '用户停用成功!此用户将不能在使用本系统' });

            reload(); // 刷新列表
          });
        }});
      },
      //重置密码
      resetpwd: function(obj) {
        var data = obj.data;
        MyCuckoo.confirm({msg : '您确认要重置此用户密码?', ok : function() {
          $.put(api.userMgr.resetPwdUrl, {id: data.userId}, item.userName).then(json => {
            MyCuckoo.msg({ msg: json.message });
          });
        }});
      },
//      //分配角色
//      assignrole: function(obj) {
//        var data = obj.data;
//        if(data.status == 'disable') {
//          MyCuckoo.alert({title: '提示', msg: '请先启用此用户'});
//          return;
//        }
//
//        MyCuckoo.dialog('分配角色', 'userMgrAssignRole.html?&id=' + data.userId);
//      },
      assign: function(obj) {
        var data = obj.data;
        layer.open({
          type: 1,
          title: "选择角色",
          area: ["400px", "80%"],
          content: '<ul id="ID_tree" class="dtree" data-id="1"></ul>',
          btn: ['确认选择'],
          success: function(layero, index){
            var treeObj = tree.render({
              elem: '#ID_tree',
              method: 'get',
              type: 'all',
              url: MyCuckoo.resolve(api.deptMgr.childNodesUrl, {id: 1, isCheckbox: true, withRole: true}),
              request: {isCheckbox: true},
              dataStyle: 'layuiStyle',
              response: { statusCode: 0, treeId: 'id', title: 'text', isLast: 'isLeaf', checkArr: 'checkbox'},
              checkbar: true,
              dot: false,
              icon: ['-1', '1']
            });
          },
          yes: function(index, layero) {
            var params = tree.getCheckbarNodesParam('tree');
            if(params.length != 1) {
              MyCuckoo.alert({msg: '请选择一个角色'});
              return;
            }

            var roleId = params[0].nodeId.replace('leaf-id-', '');
            $.put(api.userMgr.updateRoleUrl, $.extend({}, data, {roleId: roleId})).then(json => {
              MyCuckoo.msg({msg: json.message});

            this.refresh();
          });

            layer.close(index);
          }
        });
      },
      //分配权限
      assignpri: function(obj) {
        var data = obj.data;
        if (data.status == 'disable') {
          MyCuckoo.alert({ title : '提示', msg : '请先启用此用户！' });
          return;
        } else if(data.orgRoleId == 0) {
          MyCuckoo.alert({ title : '提示', msg : '请先为此用户分配有效角色！' });
          return;
        }

        var url = MyCuckoo.resolve('userMgrAssignModOpt.html?action={_event}&opt={_opt}&id={id}&name={name}',
            {'_event': obj.event, '_opt': queryObj.id, 'id': data.userId, 'name': data.name})
        MyCuckoo.dialog('分配权限', url);
      }
      //end
    }
  });
</script>