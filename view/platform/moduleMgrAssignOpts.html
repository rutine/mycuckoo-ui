<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>分配角色</title>
  <link type="image/x-icon" href="../../static/images/favicon.ico" rel="shortcut icon" />
  <link type="text/css" href="../../static/layui/2.9.8/css/layui.css" rel="stylesheet" />
  <link type="text/css" href="../../static/css/mycuckoo.css" rel="stylesheet" />

  <!-- 标签风格 -->
  <style>
    .layui-form-radio>.lay-skin-tag,
    .layui-form-checkbox>.lay-skin-tag {
      font-size: 13px;
      border-radius: 100px;
    }
    .layui-form-checked>.lay-skin-tag,
    .layui-form-radioed>.lay-skin-tag {
      color: #fff !important;
      background-color: #16b777 !important;
    }
  </style>
</head>
<body>
<div class="mycuckoo-main">
  <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend>模块名称</legend>
  </fieldset>

  <form class="layui-form layui-form-pane" name="editForm">
    <div class="layui-form-item">
      <label class="layui-form-label">请选择操作</label>
      <div id="ID_mycuckoo-tag" class="layui-input-block">

      </div>
    </div>

    <div class="layui-form-item">
      <div class="layui-input-block">
        <div class="layui-btn-group">
          <a href="javascript:" class="layui-btn layui-btn-sm" data-type="save" lay-submit>
            <i class="layui-icon layui-icon-ok"></i>保存
          </a>
          <a href="javascript:" class="layui-btn layui-btn-sm" data-type="close">
            <i class="layui-icon layui-icon-close"></i>关闭
          </a>
        </div>
      </div>
    </div>
  </form>
</div>
</body>
<script type="text/javascript" src="../../static/layui/2.9.8/layui.js" charset="UTF-8"></script>
<script type="text/javascript" src="../../static/mycuckoo.js" charset="UTF-8"></script>
<script type="text/javascript" src="../../static/mycuckoo.api.js" charset="UTF-8"></script>
<script type="text/javascript">
  layui.config({
    base: '../../static/extend/',
    version: '101100'
  });

  layui.use(['jquery', 'form'], function() {
    var $ = layui.jquery,
      form = layui.form,
      queryObj = MyCuckoo.getQueryObject(location.search),
      $form = $('form[name=editForm]');

    var FormMgr = function () {
      //表单初始赋值
      if (!queryObj.id) {
        MyCuckoo.alert({title: '提示', msg: '请选择模块!'});
        return;
      } else {
        $form.parent().find('legend').text(queryObj.name);

        $.get(api.moduleMgr.operationUrl, queryObj).then(function(json) {
          var data = json.data.source;
          var assign = json.data.assign || [];
          var $checkbox = $('<div></div>');
          for (var i = 0; i < data.length; i++) {
            var item = data[i];
            var checked = (assign.indexOf(parseInt(item.id)) >= 0) ? 'checked' : '';
            $checkbox.append('' +
                '<input type="checkbox" name="optIds[' + i + ']" lay-skin="none" value="' + item.id + '" ' + checked + '>' +
                '<div lay-checkbox class="lay-skin-tag layui-badge">' + item.text + '</div>' +
                ''
            );
          }
          $checkbox.appendTo($('#ID_mycuckoo-tag'))
          form.render('checkbox');
        });
      }

      //操作按钮触发事件
      var formMgr = this;
      $form.find('a.layui-btn:not([lay-submit])').on('click', function() {
        var type = $(this).data('type');
        formMgr[type] && formMgr[type](this);
      });

      //监听提交
      form.on('submit', function(data) {
        var type = $(this).data('type');
        formMgr[type] && formMgr[type]($.extend({}, data.field, queryObj));

        return false;
      });
    }

    FormMgr.prototype = {
      constructor: FormMgr,
      //保存模块操作
      save(data) {
        var optIds = []
        for (var p in data) {
          if (p.indexOf('optIds') == 0) {
            optIds.push(data[p]);
          }
        }
        if(!optIds.length) {
          MyCuckoo.alert({ title : '提示', msg : '请选择操作!' });
          return;
        }

        $.postJson(api.moduleMgr.saveModuleOptRefsUrl, data, optIds).then(json => {
          MyCuckoo.msg({msg: json.message});

          this.refresh();
        });
      },
      //刷新父窗
      refresh: function() {
        setTimeout(function() {
          parent.location.reload();
          this.close();
        }, 2000);
      },
      //关闭当前iframe页
      close: function(ele) {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
      }
      //end
    }

    new FormMgr();
    //end
  });

</script>
</html>